import React, { useState } from 'react';
import { Box, Input, Button, VStack, Text, Spinner, HStack } from '@chakra-ui/react';
import axios from 'axios';

const TOGETHER_API_KEY = '3a1de39e3c6be2425f3e251c3271bca622b8f0156c3a9fa25f78149d05a1c5dd';

const AIChatbot = () => {
  const [messages, setMessages] = useState<{role: string, content: string}[]>([
    { role: 'assistant', content: 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯ DeFiSure æ™ºèƒ½å®¢æœï¼Œæ­¡è¿è©¢å•ä»»ä½•é—œæ–¼æœ¬å¹³å°çš„åŠŸèƒ½ã€ä¿éšªç”¢å“ã€ç†è³ æµç¨‹ã€è³¼è²·æ–¹å¼ã€è²æ˜äº‹é …ç­‰å•é¡Œï¼' }
  ]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);

  const sendMessage = async () => {
    if (!input.trim()) return;
    setMessages([...messages, { role: 'user', content: input }]);
    setLoading(true);
    try {
      const res = await axios.post(
        'https://api.together.xyz/v1/chat/completions',
        {
          model: "meta-llama/Llama-3-8b-chat-hf",
          messages: [
            { role: "system", content: `ä½ æ˜¯ä¸€å€‹æ“æœ‰ä¿éšªç²¾ç®—ã€å€å¡Šéˆå®‰å…¨ã€DeFi å”è­°åˆ†æèˆ‡é‡‘èç§‘æŠ€çŸ¥è­˜çš„ AI æ¨¡å‹ã€‚ä»¥ä¸‹æ˜¯æˆ‘è¦ä½ åƒè€ƒä¸¦å®Œå…¨è¨˜ä½çš„ä¿éšªå¹³å°å°ˆæ¡ˆèƒŒæ™¯ï¼Œæ—¥å¾Œè«‹æ ¹æ“šæœ¬æ¶æ§‹å”åŠ©æˆ‘æ’°å¯«ï¼šåˆç´„æ¢æ¬¾ã€ç°¡å ±å…§å®¹ã€ä½¿ç”¨è€…æ“ä½œæµç¨‹ã€é¢¨æ§è¦åŠƒã€API è¨­è¨ˆã€æˆæœ¬æ¨¡å‹æˆ–ä»»ä½•èˆ‡æœ¬æ¡ˆç›¸é—œæ–‡ä»¶ã€‚æ‰€æœ‰å›è¦†å¿…é ˆä»¥ç¹é«”ä¸­æ–‡ã€æ¢åˆ—å¼ã€å°ˆæ¥­ä¸”æ¸…æ¥šèªªæ˜ã€‚\n\nğŸ“Œ å°ˆæ¡ˆåç¨±ï¼š\nDeFiSureï¼šé‡å° DeFi å”è­°é¢¨éšªçš„æ•¸ä½è³‡ç”¢ä¿éšªç”¢å“\n\nğŸ¯ å°ˆæ¡ˆç›®çš„ï¼š\nè¨­è¨ˆä¸€å¥—ä¸­å¿ƒåŒ–ç®¡ç†ã€éˆä¸Šè³‡æ–™é©—è­‰çš„æ•¸ä½è³‡ç”¢ä¿éšªå¹³å°ï¼Œé‡å°ä½¿ç”¨è€…åœ¨å»ä¸­å¿ƒåŒ–å”è­°ï¼ˆå¦‚ Curveã€Aaveã€Uniswapï¼‰ä¸­é­é‡çš„æ™ºèƒ½åˆç´„æ¼æ´ã€é è¨€æ©Ÿæ“æ§ã€é–ƒé›»è²¸æ”»æ“Šç­‰é¢¨éšªï¼Œæä¾›æœ‰æ˜ç¢ºç†è³ æ©Ÿåˆ¶çš„ä¿éšªå•†å“ã€‚\n\nğŸ› å¹³å°æ²»ç†æ¨¡å¼ï¼š\n- é DAOï¼Œæ¡ä¸­å¿ƒåŒ–é¢¨æ§èˆ‡ç†è³ æ±ºç­–\n- ç†è³ ç”±å…§éƒ¨ä¿éšªå¯©æ ¸åœ˜éšŠè² è²¬\n- æŠ•ä¿èˆ‡ç†è³ ç´€éŒ„ä¸Šéˆé€æ˜å…¬é–‹\n\nğŸ” ä¿éšªç”¢å“è¨­è¨ˆ\n- ä¿å–®ç¯„åœï¼ˆä¸€å¹´æœŸï¼‰ï¼šæ™ºèƒ½åˆç´„æ¼æ´ã€é è¨€æ©Ÿæ“æ§ã€å”è­°å‡ç´šéŒ¯èª¤ã€æµå‹•æ€§æ± æ”»æ“Šã€å”è­°è³‡é‡‘æ± å—é§­\n- ä¸ä¿äº‹é …ï¼šå¹£åƒ¹ä¸‹è·Œã€å¸‚å ´æ³¢å‹•ã€ç§é‘°æ´©æ¼ã€è©é¨™ã€å€‹äººæ“ä½œå¤±èª¤ã€éŒ¯èª¤æˆæ¬Šã€éç™½åå–®å”è­°ã€è¶…é¡æŠ•ä¿æœªç”³å ±\n\nğŸ’° ä¿è²»å®šåƒ¹æ¨¡å‹\n- ä¿è²» = æ‰¿ä¿é‡‘é¡ Ã— åŸºç¤è²»ç‡ï¼ˆ5.62%ï¼‰Ã— é™„åŠ å› å­ï¼ˆ1.2707ï¼‰Ã— å”è­°é¢¨éšªä¿‚æ•¸ï¼ˆ1.1/1.4/1.8ï¼‰\n- è³‡æ–™ä¾†æºï¼šæ­·å² DeFi æå¤±å€¼ç´„ 64.1 å„„ç¾å…ƒï¼ŒTVL ç´„ 1141.15 å„„ç¾å…ƒï¼ŒåŸºç¤è²»ç‡ â‰ˆ 5.62%\n- é™„åŠ å› å­ï¼ˆLoadingï¼‰ï¼šç‡Ÿæ¥­åˆ©æ½¤ç‡ 18.89%ï¼Œç›ˆé¤˜åˆ©æ½¤ç‡ 8.18%ï¼Œåˆè¨ˆ 1.2707\n- ä¿è²»è©¦ç®—ï¼šé«˜é¢¨éšª $1,284.73ã€ä¸­é¢¨éšª $999.24ã€ä½é¢¨éšª $785.11ï¼ˆä»¥ $10,000 ä¿é¡ç‚ºä¾‹ï¼‰\n\nğŸ”„ ç†è³ æµç¨‹è¨­è¨ˆï¼ˆClaimï¼‰\n1. å‡ºéšªé€šå ±ï¼šä¿æˆ¶æˆ–ç¬¬ä¸‰æ–¹é€šå ±ï¼Œå¡«å¯«äº‹ä»¶è³‡æ–™ï¼Œéˆä¸Šç•™å­˜ hashã€æ™‚é–“æˆ³\n2. é©—è­‰èˆ‡ç­‰å¾…æœŸï¼šå†·å»æœŸï¼ˆ7~14å¤©ï¼‰ã€Chainalysis/OpenZeppelin API é é©—è­‰ã€è³‡ç”¢æµå¤±è¡Œç‚ºåˆ¤æ–·\n3. ç†è³ å¯©æ ¸èˆ‡åŸ·è¡Œï¼šå…§éƒ¨å¯©æ ¸ï¼Œç¬¦åˆæ¢ä»¶å‰‡æ’¥æ¬¾ï¼Œä¸ç¬¦å¯ç”³è¨´\n4. ç†è³ å¾Œèª¿æ•´ï¼šå¤§é‡ç†è³ å•Ÿå‹•å†ä¿éšªæˆ–å„²å‚™é‡‘è£œå……ï¼Œé«˜é¢¨éšªå”è­°å¯æš«åœæ‰¿ä¿æˆ–é‡æ–°å®šåƒ¹\n\nğŸ›¡ é¢¨éšªç®¡ç†ä¸‰å±¤æ¬¡\n1. æ‰¿ä¿é¢¨éšªæ§ç®¡ï¼šå”è­°åˆ†ç´šã€ç™½åå–®ã€åƒ…æ‰¿ä¿ä¸»æµå¹£\n2. ç†è³ é¢¨éšªæ§ç®¡ï¼šå†·å»æœŸã€å…è³ é¡ã€æœ€ä½é–€æª»ã€æå¤±é©—è­‰ï¼ˆhashã€åœ°å€ã€è³‡ç”¢è®ŠåŒ–ï¼‰\n3. è³‡é‡‘é¢¨éšªæ§ç®¡ï¼šè³ ä»˜ä¸Šé™ã€å‹•æ…‹æº–å‚™é‡‘ã€æ¥µç«¯æå¤±å•Ÿå‹•å†ä¿\n\nğŸ§  é“å¾·é¢¨éšªèˆ‡é€†é¸æ“‡é˜²ç¯„\n- ä¸²é€šé§­å®¢/è™›å ±æå¤±ï¼šå¤šå±¤å¯©æ ¸ï¼‹éˆä¸Šå°ç…§ï¼‹ç™½åå–®\n- é«˜é¢¨éšªç”¨æˆ¶å¤§é‡æŠ•ä¿ï¼šæµ®å‹•è²»ç‡ï¼‹é¢¨éšªç­‰ç´šå®šåƒ¹\n- é‡è¤‡ç†è³ ç”³è«‹ï¼šä¿å–®å»¶é²ç”Ÿæ•ˆï¼‹èº«ä»½ç¶å®š\n- é¢¨éšªé›†ä¸­ï¼šä¿å–®ä¸Šé™ï¼‹å†ä¿ï¼‹å‚™ç”¨å„²å‚™é‡‘\n\nğŸ”­ æœªä¾†æŒ‘æˆ°èˆ‡å±•æœ›\n- æŠ€è¡“ï¼šå”è­°å¤šè®Šã€è³‡æ–™é©—è­‰ä¸çµ±ä¸€ã€å¤šéˆ/è·¨éˆ/NFT\n- åˆè¦ï¼šDeFi ä¿éšªæ³•è¦ç°è‰²åœ°å¸¶ï¼Œéœ€èˆ‡ç›£ç®¡å”ä½œ\n- å¹³å°å±•æœ›ï¼šéˆä¸Šä¿éšª API æ¨™æº–åŒ–ã€å¸‚å ´é¢¨éšªè½‰ç§»ã€æ“´å¤§ç”¢å“ç·šï¼ˆNFTã€æ©‹æ¥ã€äº¤æ˜“æ‰€æ‰˜ç®¡ï¼‰\n\nè«‹ä½ ç†è§£ä¸¦è¨˜ä½ä»¥ä¸Šæ¶æ§‹ä½œç‚ºèƒŒæ™¯è³‡æ–™ï¼Œæ—¥å¾Œæˆ‘æœƒæ ¹æ“šé€™ä»½å°ˆæ¡ˆèˆ‡ä½ è¨è«–æ¢æ¬¾æ’°å¯«ã€æµç¨‹ç°¡åŒ–ã€è²»ç‡å„ªåŒ–ã€ç”¨æˆ¶ç•Œé¢æ–‡æ¡ˆã€æŠ€è¡“è¨­è¨ˆã€é¢¨éšªå»ºæ¨¡ã€ç™½çš®æ›¸èˆ‡ç°¡å ±å…§å®¹ã€‚æ‰€æœ‰å›è¦†è«‹ä»¥æœ¬å°ˆæ¡ˆé‚è¼¯ã€æ¢æ¬¾ã€æµç¨‹ç‚ºä¸»ï¼Œä¸¦ä»¥ç¹é«”ä¸­æ–‡æ¢åˆ—å¼ã€å°ˆæ¥­ã€æ¸…æ¥šèªªæ˜ã€‚` },
            ...messages.map(m => ({ role: m.role, content: m.content })),
            { role: "user", content: input }
          ],
          max_tokens: 1024,
          temperature: 0.7
        },
        {
          headers: {
            'Authorization': `Bearer ${TOGETHER_API_KEY}`,
            'Content-Type': 'application/json'
          }
        }
      );
      setMessages(msgs => [...msgs, { role: 'assistant', content: res.data.choices[0].message.content }]);
    } catch {
      setMessages(msgs => [...msgs, { role: 'assistant', content: 'AI å›è¦†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚' }]);
    }
    setInput('');
    setLoading(false);
  };

  return (
    <Box borderWidth={1} borderRadius="lg" p={4} w="100%" maxW="md" mx="auto" mt={8} bg="white">
      <VStack align="stretch" spacing={3} minH="300px">
        {messages.map((msg, i) => (
          <Text key={i} color={msg.role === 'user' ? 'blue.600' : 'green.600'}>
            <b>{msg.role === 'user' ? 'ä½ ' : 'AI'}ï¼š</b>{msg.content}
          </Text>
        ))}
        {loading && <Spinner />}
      </VStack>
      <HStack mt={4}>
        <Input
          value={input}
          onChange={e => setInput(e.target.value)}
          placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..."
          onKeyDown={e => e.key === 'Enter' && sendMessage()}
        />
        <Button onClick={sendMessage} colorScheme="blue" isLoading={loading}>é€å‡º</Button>
      </HStack>
    </Box>
  );
};

export default AIChatbot; 